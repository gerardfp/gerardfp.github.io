<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    * {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        user-select: none;
        -webkit-user-select: none;
        /* border: 1px solid gray;; */
    }
    
    body {
        background-color: rgb(255, 255, 255);
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
    }
    
    body > * {
        grid-row: 1;
        grid-column: 1;
    }
    
    #app{
        height: 90vh;
        display: grid;
        grid-template-rows: 1fr 1fr 8fr 2fr 6fr;
        gap: 0.8em;
    }
    
    #operation {
        font-size: 7em;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #kb {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.2em;
    }
    #kb span {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.4em;
        text-align: center;
        font-size: 2em;
        border-radius: 8px;
        background-image: linear-gradient(
            45deg,
            rgb(226, 26, 226),
            rgb(208, 0, 250) 99%
        
        );
        color: white;
        box-shadow: 2px 2px 0px gray;
        font-weight: bold;
    }
    #response {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: xx-large;
    }
    #pointsW {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: right;
        font-size: 2.4em;
    }
    #conf {
        display: flex;
        justify-content: space-around;
        align-items: center;
        background-image: linear-gradient(
            45deg,
            rgb(233, 151, 0),
            rgb(255, 217, 0)
        );
        padding: 0.3em;
        border-radius: 8px;;
    }
    #conf span {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #38ff38;
        height: 2em;
        border-radius: 50%;
        aspect-ratio: 1/1;

        border: 3px solid rgb(66, 66, 66);
        color: rgb(66, 66, 66);
        font-weight: bold;
    }
    #conf span.disabled {
        background-color: #a8a8a8;
    }
    
    .shaking {
        animation: shaking 0.15s 1;
    }
    .pulse {
        animation: pulse 0.35s 1 ease-in-out;
    }
    .light {
        animation: light 0.15s 1 ease-in-out;
    }
    .push {
        animation: push 0.15s 1;
    }
    @keyframes shaking {
        0% { 
            transform: translateX(0);
        }
        25% { transform: translateX(5px) }
        50% {
            filter: blur(5px); 
            transform: translateX(-5px);
        }
        75% { transform: translateX(5px) }
        100% { transform: translateX(0);
            filter: none; 
        }
    }
    @keyframes pulse {
        25% {
            transform: scale(1.05);
            text-shadow: 0 0 1em #28c937;
        }
        100% {
            text-shadow: 0 0 0 white;
            transform: scale(1);
        }
    }
    
    @keyframes light {
        50% {
            background-color: #91ff00;
        }
    }
    @keyframes push {
        50%{
            transform: translate(2px,2px);
            box-shadow: 0 0 0 white;
        }
    }


    #nameDialog {
        border-radius: 8px;
        background-image: linear-gradient(
            45deg,
            rgb(255, 238, 0),
           
            rgb(243, 176, 31)
        );
    }
    
    #nameDialog form {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1em;
        font-size: large;
        
    }

    #playBtn {
        background-image: linear-gradient(
            45deg,
            magenta,
            rgb(149, 43, 255)
        );
        color: white;
        padding: 1em  3em;
        font-size: large;
        font-weight: bold;
        border-radius: 8px;
        border-block-start: 3px solid white;
        border-inline-start: 3px solid white;
        border-block-end: 3px solid black;
        border-inline-end: 3px solid black;
    }

    #playBtn:active {
        border-block-start: 3px solid black;
        border-inline-start: 3px solid black;
        border-block-end: 3px solid white;
        border-inline-end: 3px solid white;
    }

    
    #name {
        padding: 0.4em;
        font-size: large;
        border-radius: 8px;
        font-weight: bold;
    }

    ::backdrop {
        background-image: linear-gradient(
            45deg,
            magenta,
            rebeccapurple,
            dodgerblue,
            green
        );
        opacity: 0.75;
    }

    #nameShowW {
        background-image: linear-gradient(
            45deg,
            rgba(255, 0, 255, 0.459),
            rgba(255, 192, 203, 0.89)
        
        );
        display: inline-flex;
        width: fit-content;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border-radius: 8px;
        color: white;
        padding-inline: 1em;
    }

    #giftDialog {
        border-radius: 8px;
    }

    #giftDialog img {
        max-width: 90vw;
    }

    #playerInfo {
        display: flex;
        justify-content: space-between;
    }
    
</style>

<div id="app">
    <div id="conf">
        <span id="taula2" onclick="c(2)">2</span>
        <span id="taula3" onclick="c(3)">3</span>
        <span id="taula4" onclick="c(4)">4</span>
        <span id="taula5" onclick="c(5)">5</span>
        <span id="taula6" onclick="c(6)">6</span>
        <span id="taula7" onclick="c(7)">7</span>
        <span id="taula8" onclick="c(8)">8</span>
        <span id="taula9" onclick="c(9)">9</span>
    </div>
    <div id="playerInfo">
        <div id="nameShowW" onclick="showNameDialog()">
            <span id="nameShow"></span>
        </div>
        <div id="pointsW">
            <svg style="width: 1em; height: 1em" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">

                <defs>
                </defs>
                <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                    <circle cx="45" cy="45" r="45" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(40,201,55); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                    <path d="M 38.478 64.5 c -0.01 0 -0.02 0 -0.029 0 c -1.3 -0.009 -2.533 -0.579 -3.381 -1.563 L 21.59 47.284 c -1.622 -1.883 -1.41 -4.725 0.474 -6.347 c 1.884 -1.621 4.725 -1.409 6.347 0.474 l 10.112 11.744 L 61.629 27.02 c 1.645 -1.862 4.489 -2.037 6.352 -0.391 c 1.862 1.646 2.037 4.49 0.391 6.352 l -26.521 30 C 40.995 63.947 39.767 64.5 38.478 64.5 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                </g>
                </svg>
            <span id="points"></span></div>    
    </div>
    <div id="operation"></div>
    <div id="response"></div>
    <div id="kb">
        <span id="b0" onclick="p(0)">0</span>
        <span id="b1" onclick="p(1)">1</span>
        <span id="b2" onclick="p(2)">2</span>
        <span id="b3" onclick="p(3)">3</span>
        <span id="b4" onclick="p(4)">4</span>
        <span id="b5" onclick="p(5)">5</span>
        <span id="b6" onclick="p(6)">6</span>
        <span id="b7" onclick="p(7)">7</span>
        <span id="b8" onclick="p(8)">8</span>
        <span id="b9" onclick="p(9)">9</span>
    </div>
</div>
<dialog id="giftDialog">
    <img src="1.web" />
</dialog>

<dialog id="nameDialog">
    <form>
        <input id="name" placeholder="Nom" />
        <input type="submit" id="playBtn" value="Start!" />
    </form>
</dialog>

<script>
    let l = console.log;
    
    let nameValue="DEFAULTNAME";
    let result;
    let operationValue;
    let responseValue="";
    let pointsValue = 0;
    let taulesValue;
    
    getName();
    loadGame();
    
    function loadGame(){
        loadPoints();
        loadTaules();
        newOperation();
    }

    function setTaules(value) {
        taulesValue = value;
        
        for(let i=2; i<10; i++) {
            if (taulesValue.has(i)) {
                document.getElementById(`taula${i}`).classList.remove("disabled");
            } else {
                document.getElementById(`taula${i}`).classList.add("disabled"); 
            }
        }
        localStorage.setItem("taules", JSON.stringify(Array.from(taulesValue)));
    }
    
    function addTaules(i) {
        taulesValue.add(i);
        document.getElementById(`taula${i}`).classList.remove("disabled");
        animate(document.getElementById(`taula${i}`), "light");
        localStorage.setItem("taules", JSON.stringify(Array.from(taulesValue)));
    }
    
    function deleteTaules(i) {
        taulesValue.delete(i);
        document.getElementById(`taula${i}`).classList.add("disabled");
        localStorage.setItem("taules", JSON.stringify(Array.from(taulesValue)));
    }
    
    
    function setResponse(value){
        responseValue = value;
        response.innerHTML = responseValue;
    }
    
    function setPoints(value, showGift) {
        if (value == null) return false;
        
        pointsValue = parseInt(value);
        points.innerHTML = pointsValue;
        if (pointsValue > 0){
            animate(pointsW, "pulse");    
        }
        localStorage.setItem(`${nameValue}-points`, pointsValue);

        if (showGift && pointsValue > 0 && pointsValue % 20 == 0) {
            showGiftDialog();
        }
        return true;
    }
    
    function setOperation(value){
        operationValue = value;
        operation.innerHTML = operationValue;
    }
    

    function showGiftDialog(){
        
        giftDialog.querySelector("img").src = random(1,20) + ".webp";
        giftDialog.showModal();

        giftDialog.addEventListener("click", (e) => {
            giftDialog.close();
        })

    }

    function showNameDialog() {
        console.log(nameValue);
        
        nameDialog.querySelector("#name").value = "";
        nameDialog.querySelector("#name").placeholder = nameValue != "DEFAULTNAME" ? nameValue : "Nom";
        nameDialog.showModal();
        playBtn.addEventListener("click", (e) => {
            e.preventDefault();
            nameDialog.close(nameDialog.querySelector("#name").value);
        });
        
        nameDialog.addEventListener("close", e => {
            console.log("CLOSE", nameDialog.returnValue, nameDialog.querySelector("#name").placeholder  );
            setName(nameDialog.returnValue || (nameDialog.querySelector("#name").placeholder != "Nom" ? nameDialog.querySelector("#name").placeholder : "DEFAULTNAME"));
        });
    }

    function setName(value) {
        if (!value) return false;
        nameValue = value.toLocaleUpperCase();
        document.getElementById("nameShow").innerText = nameValue != "DEFAULTNAME" ? nameValue : "";
        
        loadPoints();
        
        if (nameValue != "DEFAULTNAME" && nameValue != "") {
            localStorage.setItem("name", nameValue);

            const searchParams = new URLSearchParams(window.location.search);
            if (searchParams.get("name") != nameValue) {
                searchParams.set("name", nameValue);
                //window.location.search = searchParams;
            }
        }
        
        return true;
    }
    
    function getName() {
        setName(new URLSearchParams(document.location.search).get("name"))
        ||
        setName(localStorage.getItem("name"))
        ||
        showNameDialog()
    }
    
    
    
    function loadPoints(){
        setPoints(new URLSearchParams(document.location.search).get(`points`), false)
        ||
        setPoints(parseInt(localStorage.getItem(`${nameValue}-points`)) || 0, false)
    }
    
    
    function loadTaules() {
        //setTaules(new Set([2,3,4,5,6,7,8,9]));
        setTaules(new Set(JSON.parse(localStorage.getItem("taules")) || [2,3,4,5,6,7,8,9]));
    }
    
    
    function newOperation(){
        let op1 = random(2,10);
        while(!taulesValue.has(op1)) op1 = random(2,10);
        let op2 = Math.floor(Math.random()*8)+2;
        
        result = ""+op1*op2;
        setOperation(op1 + "×" + op2);
    }
    
    function c(i) {
        if (taulesValue.has(i)){
            if (taulesValue.size > 1){
                deleteTaules(i);
            }
        } else {
            addTaules(i);
        }
        newOperation();
    }
    
    function p(i) {
        animate(document.getElementById(`b${i}`), "push");
        
        setResponse(`${responseValue}${i}`);
        
        if (responseValue == result) {
            setResponse("");
            setPoints(pointsValue+1, true);     
            newOperation();
        } else if (!result.startsWith(responseValue)){
            setResponse("");
            animate(app, "shaking");
        }
    }
    
    
    
    function random(min, max) {
        return Math.floor(Math.random()*(max-min))+min;
    }

    function animate(element, animation) {
        element.classList.add(animation);
        element.addEventListener('animationend', () => { element.classList.remove(animation);});
    }
</script>

