<!DOCTYPE html>
<canvas id="myCanvas"></canvas>
<img src="for.png" id="for" style="display: none;"/>
<script>
const cvs = document.getElementById("myCanvas");
const ctx = cvs.getContext("2d");


const img = document.getElementById("for");
cvs.width = img.width;
cvs.height = img.height;

class Circle {
    angle = 0;
    continuar = true;

    constructor(es, circleRadius, circleColor) {
        this.es = es;
        this.circleRadius = circleRadius;
        this.circleColor = circleColor;
        this.i = 0;     // elipse actual en la que esta rodant el circulet
        for (const e of es){
            e.t = 0;   // numero de voltes que ha pegat al voltant de la elipse ( e.l es el total que te que pegar)
            e.ts = '';  // numero d'iteracions a mostrar (per a que mostre e.t amb retard)
            e.pp = 0;   // numero de punts al voltant de la elipse que ha passat (e.p es el numero de putns en que se dividix la elipse)
        }
        this.es[0].pp = this.es[0].p*3/4-1;

    }

    draw() {
        ctx.drawImage(img,0,0);
        ctx.beginPath();
        ctx.fillStyle = this.circleColor;
        ctx.arc(this.cx, this.cy, this.circleRadius, 0, 2*Math.PI);
        ctx.fill();
        ctx.closePath();
        
        for(const e of this.es){
            ctx.strokeStyle = e.c;
            ctx.beginPath();
            ctx.lineWidth = 5;
            ctx.ellipse(e.x, e.y, e.rx, e.ry, 0, 0, 2*Math.PI);
            ctx.stroke();
            ctx.closePath();

            ctx.font = "26px sans";
            ctx.fillText(e.ts, e.x-26, e.y-e.ry)
        }

    }

    update(){

        if (!this.continuar) return;

        

        if (this.es[this.i].pp++ > this.es[this.i].p) this.es[this.i].pp = 0;

        if (this.es[this.i].pp == this.es[this.i].p*3/4) {
            for(let i = this.es.length-1; i >= 0; i--) {
                this.es[i].ts = this.es[i].t; 
            }
            let sonTotsIgual = true; 
            for(let i = this.es.length-1; i >= 0; i--) {
                if (this.es[i].t != this.es[i].l) {
                    sonTotsIgual = false;
                }                
            }

            if (sonTotsIgual) this.continuar = false;
        }

        

        if (this.es[this.i].pp == 0) {
            for(let i = this.es.length-1; i >= 0; i--) {
                if (this.es[i].t == this.es[i].l) {
                    this.es[i].t = 0;
                } else {
                    this.es[i].t++;
                    this.i = i;
                    break;
                }
            }

            
        }


        this.cx = this.es[this.i].x + this.es[this.i].rx * Math.cos(Math.PI*2*this.es[this.i].pp/this.es[this.i].p);
        this.cy = this.es[this.i].y + this.es[this.i].ry * Math.sin(Math.PI*2*this.es[this.i].pp/this.es[this.i].p);

        
    }

}

const circle = new Circle([
    {x:143, y:229, rx:113, ry:166, p: 17*4, c:"red", l:2},  // p: numero de punts en que se dividix la elipse | l: numero de voltes que te que pegar
    {x:187, y:230, rx:69, ry:100, p: 18*4,  c:"blue", l:2},
    {x:232, y:230, rx:24, ry:34, p: 18*4, c:"green", l:2}], 
    10, "yellow");

function main(){
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    circle.update();
    circle.draw();

    requestAnimationFrame(main);
}
requestAnimationFrame(main);

</script>