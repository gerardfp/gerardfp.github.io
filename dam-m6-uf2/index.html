<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="module" src="/sofi/js/script.js"></script>
<link rel="stylesheet" href="/sofi/css/estil.css">

<nav></nav>
<header>
  <h1>DAM - M6 Accés a dades - UF2 Persistència en BDR-OR-OO</h1>
  <abstract>
    Spring Boot web services using JPA

    <a href="https://github.com/gerardfp/myapi">https://github.com/gerardfp/myapi</a>
  </abstract>
</header>

<section>
    <h2>Database server</h2>

    <h3>Màquina virtual</h3>
    <p>Descarrega aquesta imagtge de disc dur virtual: <a href="https://github.com/gerardfp/gerardfp.github.io/releases/download/img/debian-11-nocloud-amd64.qcow2">debian-11-nocloud-amd64.qcow2</a></p>

    <p>Crea una nova màquina virtual amb la imatge descarregada.</p>

    <p>Inicia la màquina virtual i esbrina la seva IP.</p>

    <p>Descarrega aquesta clau privada: <a href="https://github.com/gerardfp/gerardfp.github.io/releases/download/img/id_rsa">id_rsa</a></p>

    <p>Estableix permisos <w>600</w> al fitxer de la clau:</p>

    <host>@host</host>
    <shell>
        chmod 600 <replace>/path/to/id_rsa</replace>
    </shell>

    <p>Utilitza aquesta clau per a accedir a la màquina virtual per ssh:</p>

    <host>@host</host>
    <shell>
        ssh -i <replace>/path/to/id_rsa</replace> root@<replace>192.168.122.1</replace>
    </shell>
   

    <h3>Docker Postgresql</h3>

    <p>Instal·la Docker a la màquina virtual:</p>

    <host>@virtual</host>
    <shell>
        curl -fsSL https://get.docker.com -o get-docker.sh &&  sh get-docker.sh
    </shell>

    <p>Inicia un contenidor Docker amb la base de dades PostreSQL:</p>

    <host>@virtual</host>
    <shell>
        docker run -d --name myapi-postgres -e POSTGRES_PASSWORD=mysecretpassword -e POSTGRES_USER=myapidbadmin -e POSTGRES_DB=myapidb -p 5432:5432 -v /root/db_data:/var/lib/postgresql/data postgres
    </shell>

    <optional>
        <p>Habilita l'inici automàtic del contenidor:</p>

        <scfile>
            /etc/systemd/system/myapi-postgres.service
        </scfile>
        <sc>
            [Unit]
            Description=MyApi container
            Requires=docker.service
            After=docker.service

            [Service]
            Restart=always
            ExecStart=/usr/bin/docker start -a myapi-postgres
            ExecStop=/usr/bin/docker stop -t 2 myapi-postgres

            [Install]
            WantedBy=default.target
        </sc>

        <host>@virtual</host>
        <shell>
            systemctl enable myapi-postgres.service
        </shell>
    </optional>

    <p>El següent pas és accedir al contenidor per a crear l'esquema de la base de dades.</p>
    <p>Esbrina el <w>CONTAINER ID</w> amb la comanda:</p>

    <host>@virtual</host>
    <shell>
        docker ps
    </shell>

    <p>Inicia un shell (<em>bash</em>) al contenidor amb la comanda:</p>

    <host>@virtual</host>
    <shell>
        docker exec -it <replace>6516a4b4e3c2</replace> bash
    </shell>

    <p>Accedeix al shell <w>psql</w> amb la comanda:</p>
    <host>@virtual</host>
    <shell>
        psql -U myapidbadmin myapidb
    </shell>

    <p>Copia i enganxa aquest script SQL al shell:</p>

    <sc sql>
DROP TABLE IF EXISTS movie, actor, genre, movie_actor, movie_genre CASCADE;

CREATE TABLE IF NOT EXISTS movie (
	movieid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
	title text,
	imageurl text);

CREATE TABLE IF NOT EXISTS actor (
	actorid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
	name text,
	imageurl text);

CREATE TABLE IF NOT EXISTS genre (
	genreid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
	label text);

CREATE TABLE IF NOT EXISTS movie_actor (
	movieid uuid REFERENCES movie(movieid) ON DELETE CASCADE,
	actorid uuid REFERENCES actor(actorid) ON DELETE CASCADE);

CREATE TABLE IF NOT EXISTS movie_genre (
	movieid uuid REFERENCES movie(movieid) ON DELETE CASCADE,
	genreid uuid REFERENCES genre(genreid) ON DELETE CASCADE);

INSERT INTO movie(title, imageurl) VALUES
	('Movie One','movie1.jpg'),
	('Movie Two','movie2.jpg'),
	('Movie Three','movie3.jpg'),
	('Movie Four','movie4.jpg');

INSERT INTO actor(name, imageurl) VALUES
	('Actor One','actor1.jpg'),
	('Actor Two','actor2.jpg'),
	('Actor Three','actor3.jpg'),
	('Actor Four','actor4.jpg'),
	('Actor Five','actor5.jpg');

INSERT INTO genre(label) VALUES
	('Genre One'),
	('Genre Two'),
	('Genre Three');

INSERT INTO movie_actor VALUES
	((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT actorid FROM actor WHERE name='Actor One')),
	((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT actorid FROM actor WHERE name='Actor Two')),
	((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT actorid FROM actor WHERE name='Actor Three')),
	((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT actorid FROM actor WHERE name='Actor Four')),
	((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT actorid FROM actor WHERE name='Actor Four')),
	((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT actorid FROM actor WHERE name='Actor Five')),
	((SELECT movieid FROM movie WHERE title='Movie Four'),(SELECT actorid FROM actor WHERE name='Actor One')),
	((SELECT movieid FROM movie WHERE title='Movie Four'),(SELECT actorid FROM actor WHERE name='Actor Four'));

INSERT INTO movie_genre VALUES
    ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT genreid FROM genre WHERE label='Genre One')),
    ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT genreid FROM genre WHERE label='Genre Two')),
    ((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT genreid FROM genre WHERE label='Genre One')),
    ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre One')),
    ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre Two')),
    ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre Three'));
    </sc>
</section>

<section>
    <h2>Spring boot</h2>

    <p>Accedeix a <a href="https://start.spring.io/">spring initializr</a> per a generar un projecte <strong>Spring Boot</strong></p>

    <p>Selecciona <name>Gradle Project</name></p>
    <p>Afegeix les dependències:</p>
    <ul>
        <li>Spring Web</li>
        <li>Spring Data JPA</li>
        <li>PostgreSQL Driver</li>
    </ul>

    <p>Genera el projecte i descomprimeix-lo. Obre'l amb IntelliJ</p>

    <p>Configura l'accés a la base de dades:</p>

    <scfile>
        src/main/resources/application.properties
    </scfile>
    <sc>
        spring.datasource.url= jdbc:postgresql://<replace>192.168.122.99</replace>:5432/myapidb
        spring.datasource.username= myapidbadmin
        spring.datasource.password= mysecretpassword
        spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation= true
        spring.jpa.properties.hibernate.dialect= org.hibernate.dialect.PostgreSQLDialect
    </sc>
    <!--
    <p>Afegeix una dependència més al fitxer <w>build.gradle</w>:</p>

    <scfile>
        build.gradle
    </scfile>
    <sc groovy>
        <low>
        dependencies {
            ...
        </low>
        <add>  
            implementation "org.mapstruct:mapstruct:1.4.2.Final"
            annotationProcessor "org.mapstruct:mapstruct-processor:1.4.2.Final"
        </add>
        <low>    
        }
        </low>
    </sc>

    <p>Load gradle changes <kbd>Ctrl</kbd> + <kbd>Mayús</kbd> + <kbd>O</kbd></p>
    -->
</section>

<section>
    <h2>Database migrations</h2>

    <p>La llibreria <a href="https://flywaydb.org/">Flyway</a> permet gestionar els canvis en l'esquema de la base de dades.</p>

    <p>Agegeix Flyway al projecte:</p>

    <scfile>
        build.gradle
    </scfile>
    <sc groovy>
        <low>
        plugins {
            ...
        </low>
        <add>
            id 'org.flywaydb.flyway' version '8.0.2'
        </add>
        <low>
        }
        </low>

        <add>
        flyway {
            configFiles = ['src/main/resources/application.properties']
        }
        </add>

        <low>
        dependencies {
            ... 
        </low>
        <add>
            implementation 'org.flywaydb:flyway-core:8.0.1'
        </add>
        <low>
        }
        </low>
    </sc>

    <p>Configura els paràmetres d'accés a la base de dades:</p>

    <scfile>
        src/main/resources/application.properties
    </scfile>
    <sc>
        flyway.url=jdbc:postgresql://<replace>192.168.122.99</replace>:5432/myapidb
        flyway.schemas=public
        flyway.user=myapidbadmin
        flyway.password=mysecretpassword
        spring.flyway.baseline_on_migrate=true
    </sc>

    <p>Crea una primera versió de l'esquema de la base de dades. Les migracions de l'esquema de la base de dades es 
        defineixen creant arxius al directori <folder>resources/db/migration/</folder>. El nom d'aquests arxius ha 
        de seguir una nomenclatura específica (veure: <a href="https://flywaydb.org/documentation/concepts/migrations#naming-1">migrations#naming</a>)
    </p>

    <p>Crea l'arxiu <w>resources/db/migration/V1__createdatabase.sql</w>:</p>

    <scfile>
        resources/db/migration/V1__createdatabase.sql
    </scfile>
    <sc sql>
        CREATE TABLE IF NOT EXISTS movie (
            movieid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
            title text,
            synopsis text,
            imageurl text);
        
        CREATE TABLE IF NOT EXISTS actor (
            actorid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
            name text,
            imageurl text);
        
        CREATE TABLE IF NOT EXISTS genre (
            genreid uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
            label text);
        
        CREATE TABLE IF NOT EXISTS movie_actor (
            movieid uuid REFERENCES movie(movieid) ON DELETE CASCADE,
            actorid uuid REFERENCES actor(actorid) ON DELETE CASCADE,
            PRIMARY KEY (movieid, actorid));
        
        CREATE TABLE IF NOT EXISTS movie_genre (
            movieid uuid REFERENCES movie(movieid) ON DELETE CASCADE,
            genreid uuid REFERENCES genre(genreid) ON DELETE CASCADE,
            PRIMARY KEY (movieid, genreid));
        ;
        
        INSERT INTO movie(title, synopsis, imageurl) VALUES
            ('Movie One','This is the One Movie','movie1.jpg'),
            ('Movie Two','The Two Movie is the next','movie2.jpg'),
            ('Movie Three','The Trilogy','movie3.jpg'),
            ('Movie Four','Four movies is too much','movie4.jpg');
        
        INSERT INTO actor(name, imageurl) VALUES
            ('Actor One','actor1.jpg'),
            ('Actor Two','actor2.jpg'),
            ('Actor Three','actor3.jpg'),
            ('Actor Four','actor4.jpg'),
            ('Actor Five','actor5.jpg');
        
        INSERT INTO genre(label) VALUES
            ('Genre One'),
            ('Genre Two'),
            ('Genre Three');
        
        INSERT INTO movie_actor VALUES
            ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT actorid FROM actor WHERE name='Actor One')),
            ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT actorid FROM actor WHERE name='Actor Two')),
            ((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT actorid FROM actor WHERE name='Actor Three')),
            ((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT actorid FROM actor WHERE name='Actor Four')),
            ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT actorid FROM actor WHERE name='Actor Four')),
            ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT actorid FROM actor WHERE name='Actor Five')),
            ((SELECT movieid FROM movie WHERE title='Movie Four'),(SELECT actorid FROM actor WHERE name='Actor One')),
            ((SELECT movieid FROM movie WHERE title='Movie Four'),(SELECT actorid FROM actor WHERE name='Actor Four'));
        
        INSERT INTO movie_genre VALUES
            ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT genreid FROM genre WHERE label='Genre One')),
            ((SELECT movieid FROM movie WHERE title='Movie One'),(SELECT genreid FROM genre WHERE label='Genre Two')),
            ((SELECT movieid FROM movie WHERE title='Movie Two'),(SELECT genreid FROM genre WHERE label='Genre One')),
            ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre One')),
            ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre Two')),
            ((SELECT movieid FROM movie WHERE title='Movie Three'),(SELECT genreid FROM genre WHERE label='Genre Three'));
    </sc>

</section>

<section>
    <h2>Heroku deploy</h2>

    <ul>
        <li>
            
            <p>Afegeix aquest arxiu de configuració del projecte:</p>
            <scfile>
                src/main/resources/application-production.properties
            </scfile>
            <sc>
                spring.datasource.url=${JDBC_DATABASE_URL:}
                spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
                spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

                flyway.url=${JDBC_DATABASE_URL:}
                flyway.schemas=public
                flyway.user=myapidbadmin
                flyway.password=mysecretpassword
                spring.flyway.baseline_on_migrate=true

                server.port=${PORT:}
            </sc>

            <observe>
                <p>Les variables <w>${JDBC_DATABASE_URL:}</w> i <w>${PORT:}</w> són variables d'entorn proporcionades per Heroku.</p>
            </observe>
        </li>
        <li>
            <p>Afegeix aquest arxiu al directori arrel del projecte. És la comanda que executarà Heroku per a iniciar l'aplicació:</p>
            <scfile>
                Procfile
            </scfile>
            <sc>
                web: java -Dspring.profiles.active=production -jar build/libs/myapi-0.0.1-SNAPSHOT.jar
            </sc>

            <observe>
                <p>Amb l'opció <w>-Dspring.profiles.active=production</w> li diem que agafi l'arxiu de configuració <w>application-<b>production</b>.properties</w></p>

                <p>El nom del projecte el trobaràs a l'arxiu <w>setting.gradle</w>, i la versió a l'arxiu <w>build.gradle</w>.</p>
            </observe>
        </li>
        <li>
            <p>Publica el projecte a GitHub.</p>
        </li>

        <li>
            <p>Crea un compte a <a href="heroku.com/">Heroku</a></p>
        </li>
        <li>
            <p>Crea una nova app a Heroku:</p>
            <img src="img/img1.png">

            <ul>
                <li>
                    <p>Escull "GitHub" com a Deployment method</p>
                    <img src="img/img2.png">
                </li>
                <li>
                    <p>Connecta el repositori GitHub</p>
                </li>
                <li>
                    <p>Activa el desplegament automàtic (cada cop que facis un push, es desplegarà de nou la app)</p>
                    <img src="img/img3.png">
                </li>
                <li>
                    <p>Per últim fes el desplegament inicial de la app</p>
                    <img src="img/img4.png">
                </li>
                <li>
                    <p>Afegeix el servidor Postgres a Heroku:</p>
                    <p>Ves a la pestanya <img src="img/img5.png"> i afegeix l'add-on "Heroku postgres"</p>
                    <img src="img/img6.png">
                </li>
            </ul>
        </li>
    </ul>

</section>
<!--
<section>
    docker network create keycloak-network
    docker run -d --name postgres --net keycloak-network -e POSTGRES_DB=keycloak -e POSTGRES_USER=keycloak -e POSTGRES_PASSWORD=password postgres
    docker run --rm -it --name keycloak --net keycloak-network -p 8080:8080 -p 9990:9990 -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin -e DB_USER=keycloak -e DB_PASSWORD=password -e DB_ADDR=postgres jboss/keycloak

    https://www.krakend.io/docs/authorization/keycloak/

</section>
-->
