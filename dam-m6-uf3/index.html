<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="module" src="/sofi/js/script.js"></script>
<link rel="stylesheet" href="/sofi/css/estil.css">
<style>
  fbb {
      color: #1a73e8;
      font-weight: bold;
  }

  fbb2 {
      background-color: #1a73e8;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      padding: 0.4em 1em;
  }
</style>
<nav></nav>
<header>
  <h1>DAM - M6 Accés a dades<br>UF3 - Persistència en BD natives XML</h1>
  <abstract>
    <p>Firebase es una plataforma que provee una serie de servicios para el desarrollo de apps.</p>
    <p>Entre estos servicios encontramos:</p>
    <ul>
      <li>Firebase Analytics: análisis del uso de nuestras apps</li>
      <li>Firebase Cloud Messaging: mensajes y notificaciones para iOS y Android</li>
      <li><strong>Firebase Auth: autenticacion de usuarios</strong></li>
      <li>Firebase Realtime Database: base de datos en tiempo real</li>
      <li><strong>Cloud Firestore: base de datos NoSQL</strong></li>
      <li><strong>Firebase Storage: almacenamiento de ficheros</strong></li>
      <li>Firebase Hosting: hosting de páginas web</li>
      <li>ML Kit: funciones de machine learning</li>
      <li>Crashlytics: análisis de errores en la app</li>
      <li>Performance: análisis del rendimiento de la app</li>
      <li>Firebase Test Lab: testeo de la app</li>
      <li>Admob: integración de anuncios en la app</li>
      <li>Firebase Dynamic Links: enlaces para instalar la app, con información preintroducida</li>
    </ul>
  </abstract>
</header>

<section>
    <h2>Abre el proyecto Android</h2>

    <p>Puedes usar esta plantilla como base para el proyecto: <a href="https://github.com/gerardfp/FirebaseTemplate">FirebaseTemplate</a></p>
</section>

<section>
    <h2>Conecta la app a Firebase</h2>

    <ul>
      <li><p>Selecciona <mo>Herramientas</mo><mo>Firebase</mo> para abrir la ventana del <b>Asistente</b>.</p></li>
      <li>
        <p>Haz click en <b>Authentication</b>, y luego en <b>Authenticate using Google Sign-in</b>:</p>
        <img style="width: 546.00px" src="img/firebase1.png">

        <optional>
          <p>Es posible que en lugar de <b>Authenticate using Google Sign-in</b> te aparezca 
          <b>Authenticate using email and password</b>. No importa, haz clic igualmente.</p>
        </optional>
      </li>
      <li><p>Haz clic en <b>Connect to Firebase</p></b>
        <img style="width: 339.00px" src="img/7e9110d209d0a785.png">
      </li>

      <li><p>Se abrirá la <b>Consola de Firebase</b> en el navegador web. 
        Loguéate con una cuenta y haz clic en <fbb>Add project</fbb></p>:

        <img src="img/firebase2.png">
      </li>

      <li>
        <p>Introduce un nombre del proyecto (el que desees) y haz clic en <fbb2>Continue</fbb2></p>
        <img style="width: 339.00px" src="img/firebase3.png">
      </li>
      <li>
        <p>En el paso 2, <b>no</b> es necesario que actives Google Analytics. Haz clic en <fbb2>Create project</fbb2></p>
        <img style="width: 339.00px" src="img/firebase4.png">
      </li>
    </ul>

    <h3>Añade la huella SHA-1 de la app</h3>
    <p>El siguiente paso es añadir la huella SHA-1 de nuestra app. Esto 
      permitirá a nuestra app acceder a los servicios de Firebase.

    <ul>
      <li><p>En Studio, abre la ventana <mo>Gradle</mo> y haz click en la tarea <b>signInReport</b></p>
        <img src="img/firebase7.png">
      </li>
      <li>
        <p>Copia la clave SHA-1 que aparece en el panel inferior</p>
        <img src="img/firebase8.png">
      </li>

      <li>
        <p>Ahora ve a la <a href="https://console.firebase.google.com/">Consola Firebase</a>. 
          Abre el proyecto firebase, y ve a <b>Settings</b> / <b>Project settings</b>:</p>

          <img style="width: 339.00px" src="img/firebase9.png">
      </li>

      <li>
          <p>Comprueba que esté seleccionado el nombre de package correspondiente a la app:</p>
          <img src="img/package.png">
      </li>
      <li>
        <p>Baja hasta el apartado <b>SHA certificate fingerprints</b> y haz clic en <fbb>Add fingerprint</fbb>:</p>
      
        <img style="width: 239.00px" src="img/firebase10.png">
      </li>

      <li>
        <p>Pega la clave y haz clic en <fbb2>Save</fbb2>:</p>

        <img style="width: 339.00px"  src="img/firebase11.png">

      </li>
    </ul>
</section>

<section>
    <h2>Autenticación</h2>

    <p>Una vez conectada la app con Firebase, desarollaremos la autenticación de usuarios con cuenta Google.</p>

    <h3>Añade las librerías del Firebase Authentication SDK</h3>

    <ul>
      <li>
        <p>En Studio, vuelve al asistente Firebase, y haz click en <b>Add the Firebase Authentication SDK to you app</b>:</p>
        <img style="width: 339.00px" src="img/firebase5.png">
      </li>
      <li>Aparecerá un diálogo informando de los cambios que se van a realizar en los ficheros <w>build.gradle</w>.
       Haz clic en <fbb2>Accept changes</fbb2>.</li>
    </ul>

  
  <h3>Activa el proveedor de autenticación Google</h3>

    <p>Ahora activaremos la autenticación mediante cuentas de Google.</p>

    <ul>
      <li>
        <p>En la <a href="https://console.firebase.google.com/">Consola Firebase</a>, ve al apartado <b>Authentication</b> y haz clic en <b>Get started</b>:</p>

        <img src="img/firebase12.png">
      </li>

      <li>
        <p>Haz clic en el <em>provider</em> Google. Introduce un <b>Project support email</b> y haz clic en <fbb2>Save</fbb2>:</p>
        <img src="img/firebase13.png">
      </li>
    </ul>

    <h3>Prueba la autenticación</h3>

    <p>Por último programaremos un pequeño <em>test</em> para ver que 
      la app para que realiza correctamente la auntenticación con una cuenta de Google:</p>

    <p>Primero añade estas tres dependencias en el <w>build.gradle (module: App)</w></p>
    <sc groovy>
      implementation 'com.google.android.gms:play-services-auth:19.0.0'
      implementation 'androidx.activity:activity:1.2.0-rc01'
      implementation 'androidx.fragment:fragment:1.3.0-rc01'
    </sc>

    <p>Pon este código en la <w>MainActivity</w>:</p>

    <sc java>
      import android.content.Intent;
      import android.os.Bundle;
      
      import androidx.activity.result.ActivityResultLauncher;
      import androidx.activity.result.contract.ActivityResultContracts;
      import androidx.appcompat.app.AppCompatActivity;
      
      import com.google.android.gms.auth.api.signin.GoogleSignIn;
      import com.google.android.gms.auth.api.signin.GoogleSignInOptions;
      import com.google.android.gms.common.api.ApiException;
      import com.google.firebase.auth.FirebaseAuth;
      import com.google.firebase.auth.GoogleAuthProvider;
      
      public class MainActivity extends AppCompatActivity {
      
          @Override
          protected void onCreate(Bundle savedInstanceState) {
              super.onCreate(savedInstanceState);
              setContentView(R.layout.activity_main);
      
              signInClient.launch(GoogleSignIn.getClient(this, new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN).requestIdToken(getString(R.string.default_web_client_id)).build()).getSignInIntent());
          }
      
          ActivityResultLauncher&lt;Intent&gt; signInClient = registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), result -&gt; {
              try {
                  FirebaseAuth.getInstance().signInWithCredential(GoogleAuthProvider.getCredential(GoogleSignIn.getSignedInAccountFromIntent(result.getData()).getResult(ApiException.class).getIdToken(), null));
              } catch (ApiException e) {}
          });
      }
    </sc>

    <warn>
      <p>El recurso <w>R.string.default_web_client_id</w> aparecerá en rojo debido a que no existe. 
      No te preocupes, Gradle lo generará automáticamente cuando compile la app.
      </p>
    </warn>


    <p><b>Ejecuta la app y autentícate con una cuenta de Google. Luego comprueba que en la <a href="https://console.firebase.google.com">Consola Firebase del Proyecto</a> aparece el usuario que se ha autenticado:</b></p>
    <info>
      <p>Para ejecutar la aplicación tendras que volver a seleccionar <w>app</w> en el selector de configuraciones:</p>
      <img style="width: 340px" src="img/firebase21.png">
    </info>
    <img src="img/firebase14.png">
  </section>

  <section>
    <h2>Firestore</h2>

    <p>Habilitaremos una base de datos Firestore, que permitirá a nuestra app guardar
      datos en la nube.
    </p>

    <h3>Añade las librerías del Cloud Firestore SDK</h3>
    <ul>
      <li>
        <p>Ve al <b>Asistente Firebase</b> de Android Studio, 
          y selecciona la opción <b>Cloud Firestore</b>. Haz clic en
        <b>Get started with Cloud Firestore</b></p>
          <img style="width: 339.00px"  src="img/firebase15.png">
      </li>

      <li><p>Haz clic en <b>Add the Cloud Firestore SDK to your app</b>:</p>
        <img style="width: 339.00px"  src="img/firebase16.png">
      </li>

      <li><p>Aparecerá un diálogo informando de los cambios que se van a realizar en los ficheros <w>build.gradle</w>.
        Haz clic en <fbb2>Accept changes</fbb2>.</p></li> 
    </ul>

    <h3>Crea la base de datos Firestore</h3>

    <ul>
      <li>
        <p>Ve a la <a href="https://console.firebase.google.com/">Consola de Firebase</a>, 
      y abre el proyecto firebase.</p></li>

      <li>
        <p>Ve al apartado <b>Cloud Firestore</b> y haz clic en <b>Create database</b>:</p>
        <img src="img/firebase17.png">
      </li>

      <li>
        <p>Selecciona "Start in <b>production mode</b>". Haz clic en <fbb2>Next</fbb2></p>
        <img src="img/firebase18png.png">
      </li>

      <li>
        <p>Selecciona la localización <b>eur3 (europe-west)</b> y clic en <fbb2>Enable</fbb2></p>
        <img style="width: 339.00px"  src="img/firebase19.png">
      </li>
    </ul>

    <h3>Establece las reglas de acceso a la base de datos</h3>

    <p>Cambiaremos las reglas de acceso a la base de datos para permitir la lectura y escritura</p>

    <ul>
      <li>
        <p>Ve a la pestaña <b>Rules</b> y establece las siguientes reglas:</p>

        <sc firestore-security-rules>
        rules_version = '2';
        service cloud.firestore {
            match /databases/{database}/documents {
                match /{document=**} {
                    allow read, write;
                }
            }
        }
        </sc>

        <p>Publica las reglas haciendo clic en <fbb2>Publish</fbb2>:</p>

        <img style="width: 339.00px" src="img/firebase20.png">
      </li>
    </ul>

    <h3>Prueba la base de datos</h3>

    <p>Programaremos un pequeño <em>test</em> de escritura de datos.</p>


    <sc java>
    public class MainActivity extends AppCompatActivity {

        @Override
        protected void onCreate(Bundle savedInstanceState) {

            //...


            class Post {
                public String title;
                public String message;

                Post(String t, String m){ title = t; message=m; }
            }

            FirebaseFirestore.getInstance().collection("posts").add(new Post("Hello", "hello world!"));
        }
    }
    </sc>

    <p><b>Comprueba que los datos se han guardado en la base de datos Firestore.</b></p>
  </section>

  <section>
    <h3>Storage</h3>

    <p>El servicio <b>Storage</b> permite subir ficheros a la nube, y descargarlos mediante una 
    URL de descarga.</p>

    <p>Los pasos para activarlo son los mismos que hemos hecho antes:</p>

    <ul>
      <li>
        <p>Desde el Asistente Firebase de Android Studio, añade las librerías <b>Storage</b> a la app.</p></li>
      <li><p>En la Consola Firebase, ve a la opción <b>Storage</b> y comprueba que está activado.</p></li>
      <li><p>En la sección <b>Rules</b> del Storage, edita y <b>publica</b> las reglas para permitir la 
      lectura/escritura de ficheros.</p></li>
    </ul>
    
    <p>Por último, prueba que funciona añadiendo este código a la app.</p>
    <sc java>
      // Storage
      byte[] bytes = {-1,-40,-1,-32,0,16,74,70,73,70,0,1,2,0,0,1,0,1,0,0,-1,-37,0,67,0,8,6,6,7,6,
            5,8,7,7,7,9,9,8,10,12,20,13,12,11,11,12,25,18,19,15,20,29,26,31,30,29,26,28,28,32,
            36,46,39,32,34,44,35,28,28,40,55,41,44,48,49,52,52,52,31,39,57,61,56,50,60,46,51,52,
            50,-1,-37,0,67,1,9,9,9,12,11,12,24,13,13,24,50,33,28,33,50,50,50,50,50,50,50,50,50,
            50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
            50,50,50,50,50,50,50,50,50,50,50,50,50,-1,-64,0,17,8,0,15,0,15,3,1,34,0,2,17,1,3,17,
            1,-1,-60,0,31,0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,-1,-60,0,
            -75,16,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125,1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,
            113,20,50,-127,-111,-95,8,35,66,-79,-63,21,82,-47,-16,36,51,98,114,-126,9,10,22,23,
            24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,
            87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,-125,
            -124,-123,-122,-121,-120,-119,-118,-110,-109,-108,-107,-106,-105,-104,-103,-102,-94,
            -93,-92,-91,-90,-89,-88,-87,-86,-78,-77,-76,-75,-74,-73,-72,-71,-70,-62,-61,-60,-59,
            -58,-57,-56,-55,-54,-46,-45,-44,-43,-42,-41,-40,-39,-38,-31,-30,-29,-28,-27,-26,-25,
            -24,-23,-22,-15,-14,-13,-12,-11,-10,-9,-8,-7,-6,-1,-60,0,31,1,0,3,1,1,1,1,1,1,1,1,1,
            0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,-1,-60,0,-75,17,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,
            119,0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,-127,8,20,66,-111,-95,-79,-63,
            9,35,51,82,-16,21,98,114,-47,10,22,36,52,-31,37,-15,23,24,25,26,38,39,40,41,42,53,
            54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,
            104,105,106,115,116,117,118,119,120,121,122,-126,-125,-124,-123,-122,-121,-120,-119,
            -118,-110,-109,-108,-107,-106,-105,-104,-103,-102,-94,-93,-92,-91,-90,-89,-88,-87,
            -86,-78,-77,-76,-75,-74,-73,-72,-71,-70,-62,-61,-60,-59,-58,-57,-56,-55,-54,-46,-45,
            -44,-43,-42,-41,-40,-39,-38,-30,-29,-28,-27,-26,-25,-24,-23,-22,-14,-13,-12,-11,-10,
            -9,-8,-7,-6,-1,-38,0,12,3,1,0,2,17,3,17,0,63,0,118,-85,-29,-117,29,93,87,82,-41,-76,
            109,66,-14,11,-101,-77,5,-115,-101,121,50,71,-126,-85,36,91,109,-4,-45,-105,-14,-92,
            -116,-77,-19,36,52,-123,119,0,66,-119,108,62,36,105,-2,19,-66,-123,-19,116,-19,70,
            29,52,-38,-91,-35,-35,-110,60,47,28,118,-14,15,-35,-68,113,-119,113,19,-105,120,-55,
            81,-73,43,35,51,41,59,72,-46,-15,61,-124,30,6,22,-9,23,105,101,109,111,4,-98,69,
            -122,-83,53,-97,-38,54,68,119,-108,-73,-62,-80,-107,89,87,35,119,42,85,114,78,-25,
            42,38,-16,-65,-123,-20,-4,101,100,-9,51,91,91,-51,-95,-33,74,102,-69,-71,-118,1,108,
            53,2,-91,-107,81,85,91,-51,80,-78,2,-20,-50,65,-36,-72,27,-107,-50,-33,30,10,127,89,
            -65,43,-65,-85,-73,-7,109,-78,-36,-19,110,62,-53,117,111,77,79,-1,-39};

      FirebaseStorage.getInstance().getReference("emoji.jpg").putBytes(bytes);
    </sc>

    <p><b>Comprueba que se ha subido el fichero al Storage.</b></p>
  </section>